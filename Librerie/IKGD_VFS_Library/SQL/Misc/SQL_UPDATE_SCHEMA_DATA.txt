--
-- pulizia della tabella IKG_HITLOG
--
--select min(id) from ( select top 500000 id from IKG_HITLOG order by id desc) ids;
--insert into IKG_HITLOG_ARCHIVE select * from ikg_hitlog where id < 6617910
--delete from IKG_HITLOG where id < 6617910

--script SQL per sync modifiche allo schema DB (IKGD_VNODE.placeholder varchar(100) e IKGD_VNODE.template varchar(100))
set xact_abort on
go
begin transaction
go
alter table IKGD_VNODE add placeholder varchar(100)
go
alter table IKGD_VNODE add template varchar(100)
go
commit
go

--TODO:
--script SQL per sync modifiche allo schema DB (rimozione di IKGD_VDATA.language IKGD_VDATA.flag_archived IKGD_VDATA.data IKGD_VDATA.attributes IKGD_VDATA.collector)



TRUNCATE TABLE Elmah_Error;
UPDATE IKGD_VDATA SET settings=REPLACE(settings, '"StreamInfos"', '"__StreamInfos__"') WHERE settings LIKE '%"StreamInfos"%'
UPDATE IKGD_STREAM SET source=NULL WHERE source='';
UPDATE IKGD_VDATA SET data=NULL WHERE manager_type<>'IKCMS_Limoni_ResourceType_ShopPDV' AND data IS NOT NULL;
DELETE FROM IKGD_PROPERTY WHERE [name] = 'IKCAT_Tag' AND attributeId IS NULL;
-- migrazione di vecchie risorse tipo image (ormai solo in calligaris?)
UPDATE IKGD_VDATA SET category=collector where (manager_type='IKCMS_ResourceType_Image' OR manager_type='IKCMS_ResourceType_ImageMultiStream') AND collector IS NOT NULL AND (collector <> category OR category IS NULL);
UPDATE IKGD_VDATA SET collector=NULL where collector IS NOT NULL;
-- verificare con select manager_type,category,collector,COUNT(*) from IKGD_VDATA group by manager_type,category,collector order by manager_type,category,collector;

--migrazione di language da vData a vNode
--select IKGD_VNODE.snode,IKGD_VNODE.rnode,IKGD_VNODE.language,IKGD_VDATA.language
--from IKGD_VNODE join IKGD_VDATA on IKGD_VNODE.rnode = IKGD_VDATA.rnode
--where IKGD_VDATA.language is not null and IKGD_VNODE.language is null
--
update IKGD_VNODE SET IKGD_VNODE.language=IKGD_VDATA.language
from IKGD_VNODE join IKGD_VDATA on IKGD_VNODE.rnode = IKGD_VDATA.rnode
where IKGD_VDATA.language is not null and IKGD_VNODE.language is null
update IKGD_VDATA set language=NULL where language is not null


ALTER TABLE IKGD_VDATA DROP COLUMN language;
ALTER TABLE IKGD_VDATA DROP COLUMN collector;
ALTER TABLE IKGD_VDATA DROP COLUMN attributes;
ALTER TABLE IKGD_VDATA DROP COLUMN data;

ALTER TABLE [dbo].[IKGD_VDATA] DROP CONSTRAINT [DF_IKGD_VDATA_flag_deleted1]
ALTER TABLE IKGD_VDATA DROP COLUMN flag_archived;



-- operazioni relative alle intranet
UPDATE IKGD_CONFIG SET [value]='/Portal.aspx' WHERE [value] LIKE '%Portal/Default.aspx';
UPDATE IKGD_CONFIG SET [value]='/Author.wgx' WHERE [value] LIKE '%Author/Default.wgx';
update IKGD_VNODE set [username]='anonymous' where [username] LIKE 'anon%';
update IKGD_INODE set [username]='anonymous' where [username] LIKE 'anon%';
update IKGD_VDATA set [username]='anonymous' where [username] LIKE 'anon%';
update IKGD_PROPERTY set [username]='anonymous' where [username] LIKE 'anon%';
update IKGD_RELATION set [username]='anonymous' where [username] LIKE 'anon%';
UPDATE IKGD_VDATA SET settings=REPLACE(settings, '"IKGD.Library.Resources', '"Ikon.IKGD.Library.Resources') WHERE settings LIKE '%"IKGD.Library.Resources%' ;
UPDATE IKGD_VDATA SET settings=REPLACE(settings, '#IKGD.Library.Resources', '#Ikon.IKGD.Library.Resources') WHERE settings LIKE '%#IKGD.Library.Resources%' ;
UPDATE IKGD_VDATA SET settings=REPLACE(settings, '"IKGD.Autovie', '"Autovie.IKGD') WHERE settings LIKE '%"IKGD.Autovie%' ;
UPDATE IKGD_VDATA SET settings=REPLACE(settings, '#IKGD.Autovie', '#Autovie.IKGD') WHERE settings LIKE '%#IKGD.Autovie%' ;
--eseguire la migrazione dei widget iGoogle prima di cancellare i IKGD_VDATA.data
--/BatchCMS/MigrateVDATA_data_field?committ=true


-- trasformazione della lingua slovena si->sl
UPDATE [IKGD_CONFIG] SET [value]='sl' WHERE [key]='language' AND [value]='si';
UPDATE [IKGD_VNODE] SET [language]='sl' WHERE [language]='si';
--UPDATE [IKGD_VDATA] SET [language]='sl' WHERE [language]='si';
UPDATE [IKGD_VDATA] SET [settings]=REPLACE([settings], '"Key":"si","Value":', '"Key":"sl","Value":') WHERE [settings] LIKE '%"Key":"si","Value":%';


lista dei database non ancora aggiornati e normalizzati:

[nlb1sa]
FVG_Strade_CMS
LanariGroup_CMS
OnWeb_01
OnWeb_OldWildWest


